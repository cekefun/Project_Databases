<!DOCTYPE html>
<html>
<head>
{% load staticfiles %}
<link rel="stylesheet" type="text/css" href="{% static "userpage/defaultstyle.css" %}">
</head>
<body>
<ul>
  <li><a href="../">Home</a></li>
  <li><a class="active" href="">Sensors</a></li>
  <li><a href="../minute/">MinuteData</a></li>
  <li><a href="../hour/">HourData</a></li>
  <li><a href="../day/">DayData</a></li>
  <li><a href="../month/">MonthData</a></li>
  <li><a href="../year/">YearData</a></li>
</ul>
	{% if sensor_list %}

		<br>
		<div style="overflow-x:auto;">
		<table id="tablesensorinfo">
			<tr>
				<!--  <th>Sensor ID</th>  -->
				<th>Title</th>
				<th>Apparature</th>
				<th>Description</th>
				<th>Unit</th>
				<th>Active</th>
			</tr>
		</table>
		</div>

	{% else %}
		<p>There are no sensors in the database.</p>
	{% endif %}
</body>
</html>

<script>
// testscripts in this part


function updateData(element) {

	// columnName = typeof columnName !== 'undefined' ? columnName : "Title";
	var columnName = element.getAttribute("id");
	if (columnName == "Active") {
		updateActive(element);
	}

	var newValue = prompt("Enter new value.", "");
	if (newValue == undefined)
		return;
	var sensorID = element.parentNode.getAttribute("sensorID");

	// Shenanigans moving onward from here
	// -----------------------------------

	var url = "updateSensor/";

	// console.log(element.getAttribute("id"));

	var xhttp = new XMLHttpRequest();
	xhttp.open("POST", url, true);
	xhttp.setRequestHeader("X-CSRFToken", getCookie('csrftoken')); // undermines cross site forgery
	xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // this is needed for the request to be processed like a standard form
	xhttp.send("id=" + sensorID + "&columnname=" + columnName + "&newvalue=" + newValue);

	// console.log(xhttp.responseText);
	

	element.innerHTML = newValue;
}

function updateActive(element) {
	var columnName = "Active";
	var sensorID = element.parentNode.getAttribute("sensorID");
	var newValue = "0";
	if (element.getAttribute("value") == "0")
		newValue = "1";


	//update the active value in the database
	var url = "updateSensor/";
	var xhttp = new XMLHttpRequest();
	xhttp.open("POST", url, true);
	xhttp.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
	xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xhttp.send("id=" + sensorID + "&columnname=" + columnName + "&newvalue=" + newValue);


	//update the crossmark/checkmark
	element.removeChild(element.firstChild);	
	if (newValue == "1") {
		element.appendChild(Checkmark());
		element.setAttribute("value", "1");
	}
	else {
		element.appendChild(Crossmark());
		element.setAttribute("value", "0");
	}
}


function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js">

{% load staticfiles %}
<script src="{% static "userpage/sortable.js" %}"></script>
<script>
function LoadSensorData() {
	var jsonhttp = new XMLHttpRequest();
	var url = "/index/sensors/all";

	jsonhttp.onreadystatechange = function() {
		if (jsonhttp.readyState == 4 && jsonhttp.status == 200) {
			// console.log(jsonhttp.responseText);
			var sensordataobject = JSON.parse(jsonhttp.responseText);
			DisplaySensorDataTable(sensordataobject);
		}
	}
	jsonhttp.open("GET", url, true);
	jsonhttp.send();
}


function DisplaySensorDataTable(dataobject) {
	// console.log(dataobject);
	var table = document.getElementById("tablesensorinfo");
	
	for (i = 0; i < dataobject.sensors.length; i++) {
		//create table entries
		var tablerow = document.createElement("tr");
		tablerow.setAttribute("sensorID", dataobject.sensors[i].ID);
		
		/*
		//ID
		var tableelement_id = document.createElement("td");
		tableelement_id.setAttribute("id", "ID");
		var tableelement_id_text = document.createTextNode(dataobject.sensors[i].ID);
		tableelement_id.appendChild(tableelement_id_text);
		*/

		//Apparature
		var tableelement_apparature = document.createElement("td");
		tableelement_apparature.setAttribute("ondblclick", "updateData(thi)");
		tableelement_apparature.setAttribute("id","Apparature");
		var tableelement_apparature_text = document.createTextNode(dataobject.sensors[i].Apparature);

		//Title
		var tableelement_title = document.createElement("td");
		tableelement_title.setAttribute("ondblclick", "updateData(this)");
		tableelement_title.setAttribute("id", "Title");
		var tableelement_title_text = document.createTextNode(dataobject.sensors[i].Title);

		//Description
		var tableelement_description = document.createElement("td");
		tableelement_description.setAttribute("ondblclick", "updateData(this)");
		tableelement_description.setAttribute("id", "Description");
		var tableelement_description_text = document.createTextNode(dataobject.sensors[i].Description);

		//Unit
		var tableelement_unit = document.createElement("td");
		tableelement_unit.setAttribute("ondblclick", "updateData(this)");
		tableelement_unit.setAttribute("id", "Unit");
		var tableelement_unit_text = document.createTextNode(dataobject.sensors[i].Unit);

		//Active
		var tableelement_active = document.createElement("td");
		tableelement_active.setAttribute("id", "Active");
		tableelement_active.setAttribute("ondblclick", "updateActive(this)");


		tableelement_apparature.appendChild(tableelement_apparature_text);
		tableelement_title.appendChild(tableelement_title_text);
		tableelement_description.appendChild(tableelement_description_text);
		tableelement_unit.appendChild(tableelement_unit_text);
		if (dataobject.sensors[i].Active == 1) {
			tableelement_active.appendChild(Checkmark());
			tableelement_active.setAttribute("value", "1");
		}
		else {
			tableelement_active.appendChild(Crossmark());
			tableelement_active.setAttribute("value", "0");
		}

		// tablerow.appendChild(tableelement_id);
		tablerow.appendChild(tableelement_title);
		tablerow.appendChild(tableelement_apparature);
		tablerow.appendChild(tableelement_description);
		tablerow.appendChild(tableelement_unit);
		tablerow.appendChild(tableelement_active);

		// console.log(tablerow);
		table.appendChild(tablerow);
	}
}

function Checkmark() {
	var checkmark = document.createElement("span");
	checkmark.setAttribute("class", "checkmark");

	var div1 = document.createElement("div");
	div1.setAttribute("class", "checkmark_circle");
	var div2 = document.createElement("div");
	div2.setAttribute("class", "checkmark_stem");
	var div3 = document.createElement("div");
	div3.setAttribute("class", "checkmark_kick");

	checkmark.appendChild(div1);
	checkmark.appendChild(div2);
	checkmark.appendChild(div3);
	return checkmark;
}

function Crossmark() {
	var crossmark = document.createElement("span");
	crossmark.setAttribute("class", "crossmark");

	var div1 = document.createElement("div");
	div1.setAttribute("class", "crossmark_circle");
	var div2 = document.createElement("div");
	div2.setAttribute("class", "crossmark_slash");
	var div3 = document.createElement("div");
	div3.setAttribute("class", "crossmark_backslash");

	crossmark.appendChild(div1);
	crossmark.appendChild(div2);
	crossmark.appendChild(div3);
	return crossmark;
}

window.onload = LoadSensorData;
</script>